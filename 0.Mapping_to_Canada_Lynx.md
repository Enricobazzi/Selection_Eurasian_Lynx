---
title: "Mapping_to_Canada_Lynx"
author: "Enrico"
date: "25 February 2020"
output: html_document
---

We decided to work with the new Canada Lynx genome (LyCa) as the reference. This means I will have to generate BAM files for all samples aligning the fastq reads to this reference. To speed up the process I will use the FT2 CESGA server. The process will be split into 2 steps:

## Step 1

A script (0.Mapping-executables/LL_CNAG_LyCa_mapping_launcher_cesga.sh) will sbatch a mapping to LyCa script for all elements in a folder which have a BARCODEID correspondent. BARCODEID is a "dictionary" made to have a correspondence between the sample name and the fastq name, as samples sequenced in CNAG have more than one fastq.

Note that I will use some conditions (if statements) in order to run only the samples I need:
```
if [ -f "$FILE" ]
```
to only process the files in the folder of interest, and
```
if [ ${SPECIES} == "ll" ] && [ ${POPULATION} != "ki" ] && [ ${POPULATION} != "po" ] && [ ${POPULATION} != "no" ]
```
to only process lynx lynx samples and avoid repeating the populations that Dani already processed (polonia,noruega,kirov)

It will be run on CNAG fastq folders (LYNX_XX) this way:
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh <path/to/folder/LYNX_XX/path/to/fastqs>
```
This script will check the above conditions and sbatch another script for the first steps of the mapping process (0.Mapping-executables/LL_CNAG_LyCaRef_mapping_step1_cesga.sh).

### LYNX_09
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh /mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/genomes_lynx_5x/LYNX_09
launching C6DUUANXX_2_21nf mapping of sample c_ll_vl_0107
Submitted batch job 3725584
launching C6DV6ANXX_1_21nf mapping of sample c_ll_vl_0107
Submitted batch job 3725585
launching C6DUUANXX_1_23nf mapping of sample c_ll_vl_0110
Submitted batch job 3725586
launching C6DV6ANXX_7_5nf mapping of sample c_ll_vl_0108
Submitted batch job 3726612
launching C6DUUANXX_2_22nf mapping of sample c_ll_vl_0109
Submitted batch job 3725588
launching C6DV6ANXX_1_23nf mapping of sample c_ll_vl_0110
Submitted batch job 3725589
```
### LYNX_13
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh /mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/genomes_lynx_5x/LYNX_13/20170127/FASTQ
launching C9KH1ANXX_5_13nf mapping of sample c_ll_ya_0147
Submitted batch job 3725590
launching C9KJ0ANXX_1_22nf mapping of sample c_ll_vl_0113
Submitted batch job 3725591
launching CA2W6ANXX_4_16nf mapping of sample c_ll_cr_0206
Submitted batch job 3725592
launching C9KH3ANXX_7_10nf mapping of sample c_ll_ya_0139
Submitted batch job 3725593
launching CA5U3ANXX_2_22nf mapping of sample c_ll_vl_0113
Submitted batch job 3725594
launching CA5U3ANXX_2_16nf mapping of sample c_ll_cr_0206
Submitted batch job 3725595
launching C9KH1ANXX_7_27nf mapping of sample c_ll_cr_0209
Submitted batch job 3725596
launching CA2W6ANXX_4_18nf mapping of sample c_ll_cr_0208
Submitted batch job 3725597
launching C9KH3ANXX_7_15nf mapping of sample c_ll_ya_0143
Submitted batch job 3725598
launching C9KH1ANXX_5_21nf mapping of sample c_ll_ya_0138
Submitted batch job 3725599
launching C9KH1ANXX_7_14nf mapping of sample c_ll_ya_0145
Submitted batch job 3725600
launching CA5U3ANXX_2_20nf mapping of sample c_ll_cr_0207
Submitted batch job 3725601
launching CA5U3ANXX_2_19nf mapping of sample c_ll_cr_0205
Submitted batch job 3725602
launching C9KH1ANXX_5_10nf mapping of sample c_ll_ya_0139
Submitted batch job 3725603
launching C9KH3ANXX_7_12nf mapping of sample c_ll_ya_0142
Submitted batch job 3725604
launching C9KH1ANXX_7_25nf mapping of sample c_ll_vl_0128
Submitted batch job 3725605
launching C9KH1ANXX_5_15nf mapping of sample c_ll_ya_0143
Submitted batch job 3725606
launching C9KH3ANXX_7_11nf mapping of sample c_ll_ya_0140
Submitted batch job 3725607
launching C9KH3ANXX_7_14nf mapping of sample c_ll_ya_0145
Submitted batch job 3725608
launching C9KJ0ANXX_4_19nf mapping of sample c_ll_cr_0205
Submitted batch job 3725609
launching C9KH3ANXX_8_27nf mapping of sample c_ll_cr_0209
Submitted batch job 3725610
launching C9KH1ANXX_5_12nf mapping of sample c_ll_ya_0142
Submitted batch job 3725611
launching CA5U3ANXX_2_18nf mapping of sample c_ll_cr_0208
Submitted batch job 3725612
launching C9KJ0ANXX_3_20nf mapping of sample c_ll_cr_0207
Submitted batch job 3725613
launching C9KH1ANXX_5_11nf mapping of sample c_ll_ya_0140
Submitted batch job 3725614
launching C9KH3ANXX_7_13nf mapping of sample c_ll_ya_0147
Submitted batch job 3725615
launching C9KH3ANXX_8_25nf mapping of sample c_ll_vl_0128
Submitted batch job 3725616
launching C9KJ0ANXX_2_23nf mapping of sample c_ll_vl_0132
Submitted batch job 3725617
launching CA5U3ANXX_2_23nf mapping of sample c_ll_vl_0132
Submitted batch job 3725618
launching C9KH3ANXX_7_21nf mapping of sample c_ll_ya_0138
Submitted batch job 3725619
```
### LYNX_15
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh /mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/genomes_lynx_5x/LYNX_15/LYNX_15/20170206/FASTQ
launching C9KH1ANXX_8_18nf mapping of sample c_ll_tu_0166
Submitted batch job 3725620
launching CA3D2ANXX_5_1nf mapping of sample c_ll_og_0181
Submitted batch job 3725621
launching C9KH3ANXX_8_11nf mapping of sample c_ll_la_0044
Submitted batch job 3725622
launching C9KH3ANXX_8_7nf mapping of sample c_ll_la_0053
Submitted batch job 3725623
launching C9KH1ANXX_7_1nf mapping of sample c_ll_to_0191
Submitted batch job 3725624
launching CAABGANXX_5_21nf mapping of sample c_ll_la_0052
Submitted batch job 3725625
launching C9KH1ANXX_8_13nf mapping of sample c_ll_tu_0158
Submitted batch job 3725626
launching CAABGANXX_5_15nf mapping of sample c_ll_tu_0165
Submitted batch job 3725627
launching CA3D2ANXX_5_6nf mapping of sample c_ll_ka_0188
Submitted batch job 3725628
launching CA2W6ANXX_1_2nf mapping of sample c_ll_og_0187
Submitted batch job 3725629
launching CA3D2ANXX_6_8nf mapping of sample c_ll_la_0047
Submitted batch job 3725630
launching CA2W6ANXX_4_6nf mapping of sample c_ll_ka_0188
Submitted batch job 3725631
launching CAABGANXX_5_9nf mapping of sample c_ll_la_0048
Submitted batch job 3725632
launching CA2W6ANXX_2_7nf mapping of sample c_ll_to_0190
Submitted batch job 3725633
launching C9KH3ANXX_8_13nf mapping of sample c_ll_tu_0158
Submitted batch job 3725634
launching CA3D2ANXX_6_7nf mapping of sample c_ll_to_0190
Submitted batch job 3725635
launching CA2W6ANXX_1_4nf mapping of sample c_ll_ka_0186
Submitted batch job 3725636
launching CAABGANXX_5_19nf mapping of sample c_ll_tu_0153
Submitted batch job 3725637
launching C9KH1ANXX_8_15nf mapping of sample c_ll_tu_0165
Submitted batch job 3725638
launching CA3D2ANXX_5_4nf mapping of sample c_ll_ka_0186
Submitted batch job 3725639
launching C9KH3ANXX_8_10nf mapping of sample c_ll_la_0054
Submitted batch job 3725640
launching CAABGANXX_5_14nf mapping of sample c_ll_tu_0159
Submitted batch job 3725641
launching CA2W6ANXX_2_8nf mapping of sample c_ll_la_0047
Submitted batch job 3725642
launching C9KH1ANXX_8_14nf mapping of sample c_ll_tu_0159
Submitted batch job 3725643
launching CA2W6ANXX_2_5nf mapping of sample c_ll_ka_0189
Submitted batch job 3725644
launching C9KH3ANXX_7_1nf mapping of sample c_ll_to_0191
Submitted batch job 3725645
launching C9KH1ANXX_8_19nf mapping of sample c_ll_tu_0153
Submitted batch job 3725646
launching C9KH1ANXX_8_12nf mapping of sample c_ll_tu_0157
Submitted batch job 3725647
launching CA2W6ANXX_1_3nf mapping of sample c_ll_ka_0184
Submitted batch job 3725648
launching CA3D2ANXX_5_2nf mapping of sample c_ll_og_0187
Submitted batch job 3725649
launching C9KH1ANXX_7_10nf mapping of sample c_ll_la_0054
Submitted batch job 3725650
launching C9KH3ANXX_8_12nf mapping of sample c_ll_tu_0157
Submitted batch job 3725651
launching CA3D2ANXX_6_21nf mapping of sample c_ll_la_0052
Submitted batch job 3725652
launching CA3D2ANXX_5_3nf mapping of sample c_ll_ka_0184
Submitted batch job 3725653
launching CA3D2ANXX_6_9nf mapping of sample c_ll_la_0048
Submitted batch job 3725654
launching CA3D2ANXX_5_5nf mapping of sample c_ll_ka_0189
Submitted batch job 3725655
launching CA2W6ANXX_1_1nf mapping of sample c_ll_og_0181
Submitted batch job 3725656
launching CAABGANXX_5_18nf mapping of sample c_ll_tu_0166
Submitted batch job 3725657
launching C9KH1ANXX_8_11nf mapping of sample c_ll_la_0044
Submitted batch job 3725658
launching C9KH1ANXX_7_7nf mapping of sample c_ll_la_0053
Submitted batch job 3725659
```
### LYNX_16
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh /mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/genomes_lynx_5x/LYNX_16/20170206/FASTQ
launching CA3D2ANXX_6_27nf mapping of sample h_ll_ba_0215
Submitted batch job 3725660
launching CA2W6ANXX_4_25nf mapping of sample c_ll_ba_0216
Submitted batch job 3726945
launching CA3D2ANXX_6_23nf mapping of sample h_ll_ba_0214
Submitted batch job 3725662
launching CA3D2ANXX_6_25nf mapping of sample c_ll_ba_0216
Submitted batch job 3725663
launching CA2W6ANXX_4_27nf mapping of sample h_ll_ba_0215
Submitted batch job 3726944
launching CA2W6ANXX_4_23nf mapping of sample h_ll_ba_0214
Submitted batch job 3725665
```
### LYNX_20
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh /mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/LYNX_20/FASTQ
launching HY5WLDSXX_1_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725666
launching HY5WLDSXX_1_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725667
launching HY5FMDSXX_2_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725668
launching HY5WLDSXX_3_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725669
launching HY5FMDSXX_3_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725670
launching HY5FMDSXX_1_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725671
launching HY5FMDSXX_4_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725672
launching HY5WLDSXX_2_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725673
launching HY5FMDSXX_2_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725674
launching HY5WLDSXX_4_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725675
launching HY5WLDSXX_3_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725676
launching HY5FMDSXX_4_21UDI-idt-UMI mapping of sample c_ll_ca_0240
Submitted batch job 3725677
launching HY5WLDSXX_2_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725678
launching HY5FMDSXX_3_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725679
launching HY5FMDSXX_1_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725680
launching HY5WLDSXX_4_9UDI-idt-UMI mapping of sample c_ll_ba_0224
Submitted batch job 3725681
```
### LYNX_18
```
./LL_CNAG_LyCa_mapping_launcher_cesga.sh /mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/genomes_lynx_5x/LYNX_18/20170828/FASTQ
launching CB84PANXX_7_152nfDI mapping of sample c_ll_ur_0194
Submitted batch job 3726616
launching CB84PANXX_7_164nfDI mapping of sample c_ll_ur_0195
Submitted batch job 3726617
launching CBCA6ANXX_7_176nfDI mapping of sample c_ll_ur_0200
Submitted batch job 3726618
launching CBCA6ANXX_8_117nfDI mapping of sample c_ll_ur_0199
Submitted batch job 3726619
launching CBCA6ANXX_8_105nfDI mapping of sample c_ll_ur_0203
Submitted batch job 3726620
launching CBCA6ANXX_7_188nfDI mapping of sample c_ll_ur_0196
Submitted batch job 3726621
```
### LYNX_21
```

```
### MACROGEN
Because MACROGEN samples have slightly different format for the fastq file name, I wrote a modified script for step 1 (0.Mapping-executables/LL_MACROGEN_LyCaRef_mapping_step1_cesga.sh) and sbatched it "manually" with the following loop for all samples (except c_ll_ki_0090 that was already mapped by Dani):
```
folder=/mnt/netapp1/Store_csebdjgl/lynx_genome/lynx_data/MAGROGEN
for sample in $(ls ${folder} | grep LL | grep -v LL90 | rev | cut -d'/' -f 1 | rev | cut -d '_' -f1 | uniq)
 do
  echo "mapping ${sample} from MACROGEN"
  sbatch LL_MACROGEN_LyCaRef_mapping_step1_cesga.sh ${sample} ${folder}
done

mapping LL112 from MACROGEN
Submitted batch job 3728957
mapping LL146 from MACROGEN
Submitted batch job 3728958
mapping LL212 from MACROGEN
Submitted batch job 3728959
```

## Step 2

Step 2 will consist of just one script that will be sbatched once for each sample (LL_CNAG_LyCaRef_mapping_step2_cesga.sh). This script will take all BAMs from that sample and merge them (if there are 2 or more). Then will complete the rest of the BAM post-processing steps.
```
cd $LUSTRE/LL_selection
for sample in $(ls LyCaRef_bams/*.bam | tr ' ' '\n' | rev | cut -d'/' -f1 | rev | cut -d'_' -f1-4 | sort -u)
 do
 echo "step 2 of $sample mapping"
 sbatch LL_CNAG_LyCaRef_mapping_step2_cesga.sh $sample
done

step 2 of c_ll_ba_0216 mapping
Submitted batch job 3738400
step 2 of c_ll_ba_0224 mapping
Submitted batch job 3738401
step 2 of c_ll_ca_0240 mapping
Submitted batch job 3738402
step 2 of c_ll_cr_0205 mapping
Submitted batch job 3738403
step 2 of c_ll_cr_0206 mapping
Submitted batch job 3738404
step 2 of c_ll_cr_0207 mapping
Submitted batch job 3738405
step 2 of c_ll_cr_0208 mapping
Submitted batch job 3738406
step 2 of c_ll_cr_0209 mapping
Submitted batch job 3738407
step 2 of c_ll_cr_0212 mapping
Submitted batch job 3738408
step 2 of c_ll_ka_0184 mapping
Submitted batch job 3738409
step 2 of c_ll_ka_0186 mapping
Submitted batch job 3738410
step 2 of c_ll_ka_0188 mapping
Submitted batch job 3738411
step 2 of c_ll_ka_0189 mapping
Submitted batch job 3738412
step 2 of c_ll_la_0044 mapping
Submitted batch job 3738413
step 2 of c_ll_la_0047 mapping
Submitted batch job 3738414
step 2 of c_ll_la_0048 mapping
Submitted batch job 3738415
step 2 of c_ll_la_0052 mapping
Submitted batch job 3738416
step 2 of c_ll_la_0053 mapping
Submitted batch job 3738417
step 2 of c_ll_la_0054 mapping
Submitted batch job 3738418
step 2 of c_ll_og_0181 mapping
Submitted batch job 3738419
step 2 of c_ll_og_0187 mapping
Submitted batch job 3738420
step 2 of c_ll_to_0190 mapping
Submitted batch job 3738421
step 2 of c_ll_to_0191 mapping
Submitted batch job 3738422
step 2 of c_ll_tu_0153 mapping
Submitted batch job 3738423
step 2 of c_ll_tu_0157 mapping
Submitted batch job 3738424
step 2 of c_ll_tu_0158 mapping
Submitted batch job 3738425
step 2 of c_ll_tu_0159 mapping
Submitted batch job 3738426
step 2 of c_ll_tu_0165 mapping
Submitted batch job 3738427
step 2 of c_ll_tu_0166 mapping
Submitted batch job 3738428
step 2 of c_ll_ur_0194 mapping
Submitted batch job 3738429
step 2 of c_ll_ur_0195 mapping
Submitted batch job 3738430
step 2 of c_ll_ur_0196 mapping
Submitted batch job 3738431
step 2 of c_ll_ur_0199 mapping
Submitted batch job 3738432
step 2 of c_ll_ur_0200 mapping
Submitted batch job 3738433
step 2 of c_ll_ur_0203 mapping
Submitted batch job 3738434
step 2 of c_ll_vl_0107 mapping
Submitted batch job 3738435
step 2 of c_ll_vl_0108 mapping
Submitted batch job 3738436
step 2 of c_ll_vl_0109 mapping
Submitted batch job 3738437
step 2 of c_ll_vl_0110 mapping
Submitted batch job 3738438
step 2 of c_ll_vl_0112 mapping
Submitted batch job 3738439
step 2 of c_ll_vl_0113 mapping
Submitted batch job 3738440
step 2 of c_ll_vl_0128 mapping
Submitted batch job 3738441
step 2 of c_ll_vl_0132 mapping
Submitted batch job 3738442
step 2 of c_ll_ya_0138 mapping
Submitted batch job 3738443
step 2 of c_ll_ya_0139 mapping
Submitted batch job 3738444
step 2 of c_ll_ya_0140 mapping
Submitted batch job 3738445
step 2 of c_ll_ya_0142 mapping
Submitted batch job 3738446
step 2 of c_ll_ya_0143 mapping
Submitted batch job 3738447
step 2 of c_ll_ya_0145 mapping
Submitted batch job 3738448
step 2 of c_ll_ya_0146 mapping
Submitted batch job 3738449
step 2 of c_ll_ya_0147 mapping
Submitted batch job 3738450
step 2 of h_ll_ba_0214 mapping
Submitted batch job 3738451
step 2 of h_ll_ba_0215 mapping
Submitted batch job 3738452
```
I had a problem with samples with only one BAM (the script has been corrected). I will sbatch again step 2 only for those samples (the ones that don't have the final BAM):
```
cd $LUSTRE/LL_selection
for sample in $(ls LyCaRef_bams/*.bam | tr ' ' '\n' | grep -v "_indelrealigner.bam" | rev | cut -d'/' -f1 | rev | cut -d'_' -f1-4)
 do
  echo "step 2 of $sample mapping"
  sbatch LL_CNAG_LyCaRef_mapping_step2_cesga.sh $sample
done

step 2 of c_ll_cr_0212 mapping
Submitted batch job 3741574
step 2 of c_ll_ur_0194 mapping
Submitted batch job 3741575
step 2 of c_ll_ur_0195 mapping
Submitted batch job 3741576
step 2 of c_ll_ur_0196 mapping
Submitted batch job 3741577
step 2 of c_ll_ur_0199 mapping
Submitted batch job 3741578
step 2 of c_ll_ur_0200 mapping
Submitted batch job 3741579
step 2 of c_ll_ur_0203 mapping
Submitted batch job 3741580
step 2 of c_ll_vl_0108 mapping
Submitted batch job 3741581
step 2 of c_ll_vl_0109 mapping
Submitted batch job 3741582
step 2 of c_ll_vl_0112 mapping
Submitted batch job 3741583
step 2 of c_ll_ya_0146 mapping
Submitted batch job 3741584
```
